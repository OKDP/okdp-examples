#
# Copyright 2026 The OKDP Authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
#

extraEnvRaw:
  - name: MC_INSECURE
    value: "1"
  - name: S3_ENDPOINT
    value: https://minio-default.okdp.sandbox
  - name: S3_ACCESS_KEY
    valueFrom:
      secretKeyRef:
        name: local-examples-s3
        key: accessKey
  - name: S3_SECRET_KEY
    valueFrom:
      secretKeyRef:
        name: local-examples-s3
        key: secretKey
  - name: BUCKET
    value: okdp
  - name: BUCKET_PREFIX
    value: "examples/data/raw/tripdata"
  - name: DATA_URL
    value: https://d37ci6vzurychx.cloudfront.net/trip-data
  - name: TRINO_SERVER_URL
    value: https://trino-default.okdp.sandbox
  - name: TRINO_TERMINAL
    value: dumb

commands:
  nyc_trip:
    # https://www.nyc.gov/site/tlc/about/tlc-trip-record-data.page
    01-download-nyc-tripdata: |
      mkdir -p /data/tripdata
      cd /data/tripdata;
      for dataset in yellow green fhv; do
        for month in 01 02 03; do
          file="${dataset}_tripdata_2025-${month}.parquet";
          url="$DATA_URL/$file";
          echo "‚Üí $url";
          if curl -fsSLO "$url"; then
            echo "‚úÖ Downloaded: $file";
          else
            echo "‚ö†Ô∏è Missing: $file";
          fi;
        done;
      done;
      ls -lh /data/tripdata
      echo "‚úÖ All downloads complete.";

    02-upload-nyc-tripdata-into-s3: |
      echo "üëâ Connect into S3"
      mc alias set myminio $S3_ENDPOINT "$S3_ACCESS_KEY" "$S3_SECRET_KEY"
      echo "üëâ MinIO alias configured successfully."
      ### echo "üëâ Clean the examples folder if it exists"
      ### mc rm --recursive --force myminio/$BUCKET/examples
      echo "üëâ Create the bucket if not exist"
      mc mb myminio/$BUCKET || true
      echo "üëâ Upload sample files into the correct folders"
      
      for category in yellow green fhv; do
        echo "üöÄ Processing category: $category"
        for file in /data/tripdata/${category}_*.parquet; do
          [ -e "$file" ] || continue  # skip if no files match
          month=$(basename "$file" | sed -E 's/.*_([0-9]{4}-[0-9]{2})\.parquet/\1/')
          echo "üì¶ Uploading $file ‚Üí ${BUCKET_PREFIX}/$category/month=$month/"
          mc cp "$file" "myminio/$BUCKET/${BUCKET_PREFIX}/$category/month=$month/"
        done
      done
    
      echo "üëâ Verify bucket structure"
      mc tree myminio/$BUCKET
      mc ls --recursive myminio/$BUCKET

    03-nyc-tripdata-trino-external-tables.sql: |
      trino --server ${TRINO_SERVER_URL} --insecure <<SQL
        CREATE SCHEMA IF NOT EXISTS lakehouse.nyc_tripdata;
        
        CREATE TABLE IF NOT EXISTS lakehouse.nyc_tripdata.yellow (
          vendorid INT,
          tpep_pickup_datetime TIMESTAMP,
          tpep_dropoff_datetime TIMESTAMP,
          passenger_count INT,
          trip_distance DOUBLE,
          ratecodeid INT,
          store_and_fwd_flag VARCHAR,
          pulocationid INT,
          dolocationid INT,
          payment_type INT,
          fare_amount DOUBLE,
          extra DOUBLE,
          mta_tax DOUBLE,
          tip_amount DOUBLE,
          tolls_amount DOUBLE,
          improvement_surcharge DOUBLE,
          total_amount DOUBLE,
          congestion_surcharge DOUBLE,
          airport_fee DOUBLE,
          cbd_congestion_fee DOUBLE,
          month VARCHAR
        )
        WITH (
          external_location = 's3a://${BUCKET}/${BUCKET_PREFIX}/yellow/',
          format = 'PARQUET',
          partitioned_by = ARRAY['month']
        );
          
        CREATE TABLE IF NOT EXISTS lakehouse.nyc_tripdata.green (
          vendorid INT,
          lpep_pickup_datetime TIMESTAMP,
          lpep_dropoff_datetime TIMESTAMP,
          store_and_fwd_flag VARCHAR,
          ratecodeid INT,
          pulocationid INT,
          dolocationid INT,
          passenger_count INT,
          trip_distance DOUBLE,
          fare_amount DOUBLE,
          extra DOUBLE,
          mta_tax DOUBLE,
          tip_amount DOUBLE,
          tolls_amount DOUBLE,
          improvement_surcharge DOUBLE,
          total_amount DOUBLE,
          payment_type INT,
          trip_type INT,
          congestion_surcharge DOUBLE,
          cbd_congestion_fee DOUBLE,
          month VARCHAR
        )
        WITH (
          external_location = 's3a://${BUCKET}/${BUCKET_PREFIX}/green/',
          format = 'PARQUET',
          partitioned_by = ARRAY['month']
        );
        
        CREATE TABLE IF NOT EXISTS lakehouse.nyc_tripdata.fhv (
          dispatching_base_num VARCHAR,
          pickup_datetime TIMESTAMP,
          dropoff_datetime TIMESTAMP,
          pulocationid INT,
          dolocationid INT,
          sr_flag INT,
          affiliated_base_number VARCHAR,
          month VARCHAR
        )
        WITH (
          external_location = 's3a://${BUCKET}/${BUCKET_PREFIX}/fhv/',
          format = 'PARQUET',
          partitioned_by = ARRAY['month']
        );
      SQL

    04-nyc-tripdata-trino-synchronize-partitions: |
      trino --server ${TRINO_SERVER_URL} --insecure <<SQL
        CALL lakehouse.system.sync_partition_metadata(
          schema_name => 'nyc_tripdata',
          table_name => 'yellow',
          mode => 'ADD'
        );
        CALL lakehouse.system.sync_partition_metadata(
          schema_name => 'nyc_tripdata',
          table_name => 'green',
          mode => 'ADD'
        );
        CALL lakehouse.system.sync_partition_metadata(
          schema_name => 'nyc_tripdata',
          table_name => 'fhv',
          mode => 'ADD'
        );
      SQL

    05-nyc-tripdata-trino-validate: |
      trino --server ${TRINO_SERVER_URL} --insecure <<SQL
        SHOW SCHEMAS FROM lakehouse;
      
        SHOW TABLES FROM lakehouse.nyc_tripdata;
      
        DESCRIBE lakehouse.nyc_tripdata.yellow;
        DESCRIBE lakehouse.nyc_tripdata.green;
        DESCRIBE lakehouse.nyc_tripdata.fhv;
        
        SELECT *
        FROM lakehouse.nyc_tripdata.yellow
        LIMIT 10;
      SQL

